#!/usr/bin/env bash
# .git/hooks/pre-commit - Run auto-formatter and stage any changes.
set -Eeuo pipefail

# Source the shared config file
# shellcheck source=../scripts/config.sh
source "$(git rev-parse --show-toplevel)/scripts/config.sh"

# --- Start Logging ---
script_name="pre-commit"
LOG_FILE=$(init_script_logging "$script_name")
enable_error_trap "$LOG_FILE" "$script_name"
# --- End Logging ---

# Ensure we are in the project root
cd "$(git rev-parse --show-toplevel)"

log INFO "⏳ Running pre-commit auto-formatter..."
./scripts/lint.sh 2>&1 | tee -a "$LOG_FILE"
EXIT_CODE=${PIPESTATUS[0]}

if [ $EXIT_CODE -ne 0 ]; then
    log ERROR "❌ An unexpected error occurred during formatting. Commit aborted."
    exit 1
fi

# Stage any files that were modified by the linter.
# 'git diff --name-only --cached' lists files already staged for commit.
# 'git add' will re-stage them if they were modified.
log INFO "✓ Staging any files modified by the linter..."
git add -u

log INFO "✅ Pre-commit checks passed."
exit 0
